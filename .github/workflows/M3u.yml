name: M3U Playlist Otomatik Guncelleyici

on:
  workflow_dispatch:      # Manuel tetikleme butonu
  schedule:
    - cron: '0 */6 * * *' # 6 saatte bir otomatik calis

jobs:
  guncelle:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Depoyu Kontrol Et (Checkout)
        uses: actions/checkout@v4

      - name: Python Kur
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Kutuphaneleri Yukle
        run: pip install requests

      # --- PYTHON SCRIPTI BASLANGICI ---
      - name: Python Scriptini Hazirla
        run: |
          cat << 'EOF' > splitter.py
          import os
          import requests
          import re

          # --- AYARLAR ---
          URL = "http://plusjustone.xyz:8080/get.php?username=b4h8feZC&password=cRzefU4&type=m3u"
          
          # Sunucunun bizi engellememesi icin sahte kimlik (User-Agent)
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          }

          DIR_LIVE = "CanliTV"
          DIR_MOVIES = "Filmler"
          DIR_SERIES = "Diziler"

          def sanitize(name):
              return re.sub(r'[<>:"/\\|?*]', '', name).strip()

          def main():
              print("Baglanti kuruluyor...")
              try:
                  # Timeout suresini uzattik ve Headers ekledik
                  resp = requests.get(URL, headers=HEADERS, timeout=60)
                  resp.raise_for_status()
                  content = resp.text
                  
                  if len(content) < 100:
                      print("HATA: Sunucudan bos veya cok kisa veri geldi!")
                      print("Gelen veri:", content[:200])
                      exit(1) # Hata verip durdur
                      
                  print(f"Basarili! {len(content)} karakter indirildi.")
                  
              except Exception as e:
                  print(f"Baglanti Hatasi: {e}")
                  exit(1)

              lines = content.split('\n')
              
              # Klasorleri olustur
              os.makedirs(DIR_LIVE, exist_ok=True)
              os.makedirs(DIR_MOVIES, exist_ok=True)
              os.makedirs(DIR_SERIES, exist_ok=True)

              # Ana listeler
              m_live = ["#EXTM3U"]
              m_mov = ["#EXTM3U"]
              m_ser = ["#EXTM3U"]
              
              # Kategori listeleri
              c_live = {}
              c_mov = {}
              c_ser = {}

              curr_grp = "Diger"
              is_inf = False
              buf = ""

              print("Ayristirma basliyor...")
              
              for line in lines:
                  line = line.strip()
                  if not line: continue

                  if line.startswith("#EXTINF"):
                      is_inf = True
                      buf = line
                      match = re.search(r'group-title="([^"]+)"', line)
                      curr_grp = match.group(1) if match else "Genel"
                      
                  elif not line.startswith("#") and is_inf:
                      url = line
                      full = f"{buf}\n{url}"
                      grp_up = curr_grp.upper()

                      # Kategori Mantigi
                      if any(x in grp_up for x in ["VOD", "FILM", "MOVIE", "SINEMA", "2023", "2024"]):
                          m_mov.append(full)
                          if curr_grp not in c_mov: c_mov[curr_grp] = ["#EXTM3U"]
                          c_mov[curr_grp].append(full)
                          
                      elif any(x in grp_up for x in ["DIZI", "SERIES", "SEZON", "EPISODE"]):
                          m_ser.append(full)
                          if curr_grp not in c_ser: c_ser[curr_grp] = ["#EXTM3U"]
                          c_ser[curr_grp].append(full)
                          
                      else:
                          m_live.append(full)
                          if curr_grp not in c_live: c_live[curr_grp] = ["#EXTM3U"]
                          c_live[curr_grp].append(full)
                      
                      is_inf = False

              # Dosyalari Yazdirma Fonksiyonu
              def save_cats(cats, folder):
                  for name, items in cats.items():
                      safe = sanitize(name) or "Isimsiz"
                      with open(f"{folder}/{safe}.m3u", "w", encoding="utf-8") as f:
                          f.write("\n".join(items))

              save_cats(c_live, DIR_LIVE)
              save_cats(c_mov, DIR_MOVIES)
              save_cats(c_ser, DIR_SERIES)

              # Toplu dosyalari yaz
              with open(f"{DIR_LIVE}/TUM_CANLI.m3u", "w", encoding="utf-8") as f: f.write("\n".join(m_live))
              with open(f"{DIR_MOVIES}/TUM_FILMLER.m3u", "w", encoding="utf-8") as f: f.write("\n".join(m_mov))
              with open(f"{DIR_SERIES}/TUM_DIZILER.m3u", "w", encoding="utf-8") as f: f.write("\n".join(m_ser))
              
              print("Islem tamamlandi.")
          EOF
      # --- PYTHON SCRIPTI BITIS ---

      - name: Scripti Calistir
        run: python splitter.py

      - name: GitHub'a Kaydet
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # HATA COZUMU: Isim vererek degil, noktayla "her seyi" ekle diyoruz.
          git add .
          
          # Eger dosya degismemisse hata verme, devam et
          git commit -m "Playlist Guncellendi" || echo "Degisiklik yok, commit atlanildi."
          
          git push
