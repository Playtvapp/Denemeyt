name: M3U Playlist Kategorize Edici

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  fetch-process-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Depoyu Klonla
      - name: Depoyu Klonla (Checkout)
        uses: actions/checkout@v4

      # 2. Python Kurulumu (Metin işleme için gerekli)
      - name: Python Kurulumu
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3. Gerekli Kütüphaneyi Yükle
      - name: Requests Kütüphanesini Yükle
        run: pip install requests

      # 4. Listeyi İndir ve Kategorilere Ayır (Python Script)
      - name: Listeyi İşle ve Kategorize Et
        shell: python
        run: |
          import requests
          import re
          import os
          import shutil

          # --- AYARLAR ---
          url = "http://plusjustone.xyz:8080/get.php?username=b4h8feZC&password=cRzefU4&type=m3u"
          output_folder = "kategoriler"

          # Klasör temizliği (Eski dosyaları silip yenilerini oluşturmak için)
          if os.path.exists(output_folder):
              shutil.rmtree(output_folder)
          os.makedirs(output_folder)

          print("Liste indiriliyor...")
          try:
              response = requests.get(url, timeout=60)
              response.raise_for_status()
              content = response.text
          except Exception as e:
              print(f"Hata oluştu: {e}")
              exit(0) # Hata olsa bile akışı bozma (continue-on-error mantığı)

          print("İçerik analiz ediliyor...")
          lines = content.splitlines()
          categories = {}
          
          # M3U İşleme Mantığı
          for i in range(len(lines)):
              line = lines[i].strip()
              
              if line.startswith("#EXTINF"):
                  # group-title="..." kısmını bul
                  match = re.search(r'group-title="([^"]+)"', line)
                  
                  if match:
                      # Kategori ismini al
                      category_name = match.group(1).strip()
                  else:
                      # Kategori yoksa "Genel" yap
                      category_name = "Genel"

                  # Dosya isminde sorun çıkaracak karakterleri temizle
                  safe_filename = re.sub(r'[\\/*?:"<>|]', "", category_name)
                  if not safe_filename: safe_filename = "Diger"

                  if safe_filename not in categories:
                      categories[safe_filename] = []

                  # EXTINF satırını ekle
                  categories[safe_filename].append(line)
                  
                  # Bir sonraki satır (URL) var mı kontrol et ve ekle
                  if i + 1 < len(lines):
                      url_line = lines[i+1].strip()
                      if not url_line.startswith("#"):
                          categories[safe_filename].append(url_line)

          # Dosyaları Yazdır
          print(f"Toplam {len(categories)} kategori bulundu. Dosyalar yazılıyor...")
          
          for cat_name, lines_list in categories.items():
              file_path = os.path.join(output_folder, f"{cat_name}.m3u")
              with open(file_path, "w", encoding="utf-8") as f:
                  f.write("#EXTM3U\n")
                  f.write("\n".join(lines_list))

          print("İşlem tamamlandı.")

      # 5. Değişiklikleri Depoya Gönder (Commit)
      - name: Değişiklikleri Commit'le ve Push'la
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Yeni oluşan klasörü git'e ekle
          git add kategoriler/
          
          # Değişiklik varsa commit at
          if git diff-index --quiet HEAD; then
            echo "Değişiklik yok, commit atılmayacak."
          else
            git commit -m "Otomatik Güncelleme: Kategorize edilmiş listeler yüklendi"
            git push
          fi
